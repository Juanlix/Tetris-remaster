<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Tetris</title>
    <link rel="icon" type="image/png" href="images/icons/icon-192x192.png">
    <link rel="manifest" href="manifest.json">
	<link rel="stylesheet" href="css/styles.css">
</head>
<body>
<div id="tetris">
	
    <div id="startScreen">
        <h1>Tetris</h1>
        <form id="playerForm">
            <input type="text" id="playerName" placeholder="Ingresa tu nombre" required>
            <button type="submit">Comenzar Juego</button>
        </form>
    </div>

	<canvas id="scene"></canvas>
	<div id="gameOver">
		<h1>Game Over !</h1>
		<h3>Score: <span id="finalScore">0</span></h3>
		<h2><a href="#" id="restart">Restart</a></h2>
	</div>
	<div id="side">
		<div id="info">
			<h1 id="levelInfo">Level: <br><span id="level">1</span></h1>
			<h2 id="scoreInfo">Score: <br><span id="score" >0</span></h2>
			<div id="rewardInfo" class="invisible">+<span id="reward">0</span></div>
			<canvas id="preview"></canvas>
		</div>
	</div>
    <div id="rankingBox">
        <h4>🏆 Ranking</h4>
         <h5><b>sin Ranking</b></h5>
   </div>
   <div id="version">
     <h4>🏆 V.19.3</h4>
   </div>
    <div id="pwa">
        <button id="installBtn" style="display: none;">📲 Instalar App</button> 
        </div>
</div>

</body>
<script>
    let deferredPrompt; // Variable para almacenar el evento de instalación

    // 1. Registro del Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js', { scope: './' })
        .then(reg => console.log('Service Worker registrado', reg))
        .catch(err => console.error('Error al registrar el Service Worker', err));
    }

    // 2. Lógica para el botón de instalación de la PWA
    window.addEventListener('beforeinstallprompt', (e) => {
        // Prevenir que la mini-barra de información aparezca automáticamente
        e.preventDefault();
        // Guardar el evento para dispararlo más tarde
        deferredPrompt = e;
        // Mostrar el botón de instalación (si estaba oculto por CSS)
        const installButton = document.getElementById('installBtn');
        if (installButton) {
            installButton.style.display = 'inline-block';
        }
        console.log('Evento beforeinstallprompt disparado y botón mostrado');
    });

    // Escuchar el clic en el botón de instalación
    document.getElementById('installBtn').addEventListener('click', () => {
        if (deferredPrompt) {
            // Mostrar el prompt de instalación al usuario
            deferredPrompt.prompt();
            // Esperar a que el usuario responda al prompt
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('Usuario aceptó la instalación de la PWA');
                } else {
                    console.log('Usuario rechazó la instalación de la PWA');
                }
                // Limpiar el evento para que no se pueda usar de nuevo
                deferredPrompt = null;
                // Ocultar el botón después de que el prompt se haya mostrado
                const installButton = document.getElementById('installBtn');
                if (installButton) {
                    installButton.style.display = 'none';
                }
            });
        }
    });
    (function() {
        document.getElementById('playerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const playerName = document.getElementById('playerName').value;
            localStorage.setItem('playerName', playerName);
            
            document.getElementById('startScreen').style.display = 'none';
            const tetris = new Tetris('tetris');
            tetris.start();
        });

        const savedName = localStorage.getItem('playerName');
        if (savedName) {
            document.getElementById('playerName').value = savedName;
        }
    })();

    </script>
</script>
<script src="dist/tetris.js"></script>